name: Release MTXPanel (Linux x64)

on:
    push:
        tags:
            - "v*" # Trigger on tags like v1.0.0
permissions:
  contents: write
  
jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.18.3"

            - name: Install dependencies
              run: npm i

            - name: Build for production
              run: npm run production # Assumes this generates files in `dist/`

            - name: Install pkg globally
              run: npm install -g pkg

            - name: Create binary with Swagger assets
              run: |
                  # Create the binary with all necessary assets
                  pkg . \
                    --target node18-linux-x64 \
                    --assets "addons/swagger.yaml" \
                    --assets "addons/**/*.yaml" \
                    --assets "addons/**/*.yml" \
                    --output mtxpanel-linux-x64

            - name: Verify binary contains Swagger
              run: |
                  # Check if binary was created
                  if [ -f "mtxpanel-linux-x64" ]; then
                      echo "✅ Binary created successfully"
                      ls -la mtxpanel-linux-x64
                  else
                      echo "❌ Binary creation failed"
                      exit 1
                  fi

            - name: Compress binary and files into mtxpanel-linux-x64.tar.gz
              run: |
                  # Create directory structure
                  mkdir -p package/dist
                  
                  # Copy necessary files
                  cp mtxpanel-linux-x64 package/
                  cp -r dist/* package/dist/ 2>/dev/null || true
                  cp .env.example package/
                  cp mtxpanel.service package/
                  cp lib/ package/ -r 2>/dev/null || true
                  
                  # Create tar.gz
                  tar -czvf mtxpanel-linux-x64.tar.gz -C package/ .

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  name: "MTXPanel Linux x64 - ${{ github.ref_name }}"
                  tag_name: ${{ github.ref_name }}
                  body: "Production build for Linux x64. Version: ${{ github.ref_name }}"
                  files: |
                      mtxpanel-linux-x64.tar.gz
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}